name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE"
      - "CHANGELOG.md"
      - "ROADMAP.md"
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE"
      - "CHANGELOG.md"
      - "ROADMAP.md"
  workflow_dispatch:
    inputs:
      go-version:
        description: "Go version to use"
        required: false
        default: "stable"
        type: string

# Set minimal permissions by default
permissions:
  contents: read

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: ${{ github.event.inputs.go-version || 'stable' }}
  CGO_ENABLED: 0

jobs:
  # Fast feedback job for basic checks
  pre-check:
    name: Pre-check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      go-version: ${{ steps.setup-go.outputs.go-version }}
      cache-hit: ${{ steps.cache-go-modules.outputs.cache-hit }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set up Go
        id: setup-go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          check-latest: true
          cache: true

      - name: Cache Go modules
        id: cache-go-modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Check formatting
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
              echo "The following files are not formatted:"
              gofmt -s -l .
              exit 1
          fi

      - name: Check go.mod/go.sum consistency
        run: go mod tidy && git diff --exit-code go.mod go.sum

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: pre-check
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ["stable", "oldstable"]
        exclude:
          # Reduce matrix size - test oldstable only on ubuntu
          - os: macos-latest
            go-version: oldstable
          - os: windows-latest
            go-version: oldstable

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests with race detection
        run: go test -v -race -timeout=10m -coverprofile=coverage.out -covermode=atomic ./...

      - name: Run tests with -short flag
        run: go test -v -short -timeout=5m ./...

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.go-version == 'stable'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          flags: unittests-${{ matrix.os }}
          name: codecov-${{ matrix.os }}
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Generate coverage report
        if: matrix.os == 'ubuntu-latest' && matrix.go-version == 'stable'
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage HTML
        if: matrix.os == 'ubuntu-latest' && matrix.go-version == 'stable'
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage.html
          retention-days: 30

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: pre-check
    permissions:
      contents: read
      pull-requests: read # For golangci-lint-action

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=10m --verbose
          skip-cache: false

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: pre-check
    permissions:
      contents: read
      security-events: write # For uploading SARIF results

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Run Gosec Security Scanner
        uses: securecodewarrior/github-action-gosec@master
        with:
          args: "-no-fail -fmt sarif -out gosec-results.sarif ./..."

      - name: Upload SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gosec-results.sarif

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: pre-check
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Build juleson (optimized)
        run: go build -v -ldflags="-s -w -X main.version=${{ github.sha }} -X main.buildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" -trimpath -o bin/juleson ./cmd/juleson

      - name: Build jules-mcp (optimized)
        run: go build -v -ldflags="-s -w -X main.version=${{ github.sha }} -X main.buildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" -trimpath -o bin/jules-mcp ./cmd/jules-mcp

      - name: Test binaries (Unix)
        if: runner.os != 'Windows'
        run: |
          ./bin/juleson --version || echo "Version flag not implemented yet"
          ./bin/jules-mcp --help || echo "Help flag not implemented yet"

      - name: Test binaries (Windows)
        if: runner.os == 'Windows'
        run: |
          .\bin\juleson.exe --version || echo "Version flag not implemented yet"
          .\bin\jules-mcp.exe --help || echo "Help flag not implemented yet"

      - name: Run go vet
        run: go vet ./...

      - name: Check for ineffective assignments
        run: go run honnef.co/go/tools/cmd/staticcheck@latest ./...

      - name: Upload binaries
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v6
        with:
          name: jules-binaries-${{ runner.os }}
          path: bin/
          retention-days: 30

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: pre-check
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Run benchmarks
        run: go test -bench=. -benchmem -run=^$ ./...

      - name: Run memory profiling
        run: go test -memprofile=mem.out -run=^$ ./...

  all-checks-pass:
    name: All Checks Pass
    if: always()
    needs:
      [
        pre-check,
        test,
        lint,
        security,
        build,
        dependency-review,
        performance-test,
      ]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Check all job statuses
        run: |
          # Define required jobs
          required_jobs="pre-check test lint security build dependency-review performance-test"

          # Check each required job
          for job in $required_jobs; do
              status="${{ needs.$job.result }}"
              if [[ "$status" != "success" && "$status" != "skipped" ]]; then
                  echo "‚ùå Job '$job' failed with status: $status"
                  exit 1
              fi
          done

          echo "‚úÖ All required jobs passed successfully!"
          echo "üöÄ CI pipeline completed successfully"
